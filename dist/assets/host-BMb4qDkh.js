import{c as b,a as B,b as S,g as v,C as r,d as w,e as T,f as k}from"./storage-D35zsQYn.js";import R from"https://esm.sh/qrcode@1.5.3";import{joinRoom as P}from"https://esm.sh/trystero/mqtt";const D=k(localStorage),N=T(D),M=w(R);let n,l,t,o=null,g=0;const d=document.getElementById("status-dot"),s=document.getElementById("status-text"),m=document.getElementById("peer-count"),C=document.getElementById("create-session"),y=document.getElementById("leave-session"),f=document.getElementById("qr-section"),L=document.getElementById("qr-code"),q=document.getElementById("room-id"),i=document.getElementById("llm-input"),p=document.getElementById("output"),E=document.getElementById("start-btn"),I=document.getElementById("stop-btn");function h(e){switch(d.className="status-dot",e){case r.CONNECTED:d.classList.add("connected"),s.textContent="Connected";break;case r.CONNECTING:d.classList.add("connecting"),s.textContent="Connecting...";break;case r.ERROR:s.textContent="Error";break;default:s.textContent="Disconnected"}}window.createSession=async function(){try{l=b({onTextChange:e=>{p.textContent=e||"Waiting for stream...",document.getElementById("char-count").textContent=e.length}}),n=B({onPeerJoin:e=>{console.log("Peer joined:",e),m.textContent=`${n.getPeerCount()} peer(s)`,n.broadcast(l.getState())},onPeerLeave:e=>{console.log("Peer left:",e),m.textContent=`${n.getPeerCount()} peer(s)`},onStateChange:h,onData:(e,a)=>{g++,document.getElementById("sync-count").textContent=g}}),t=S(l,n),o=v(),await n.join(o,P),await M.generateToCanvas(L,o),q.textContent=`Room: ${o}`,f.style.display="block",C.disabled=!0,y.disabled=!1,N.saveDocument(o,{created:Date.now()})}catch(e){console.error("Failed to create session:",e),alert("Failed to create session: "+e.message)}};window.leaveSession=function(){n&&n.leave(),f.style.display="none",C.disabled=!1,y.disabled=!0,o=null,m.textContent="0 peers",h(r.DISCONNECTED)};window.startStreaming=function(){t&&(t.startStream(),E.disabled=!0,I.disabled=!1,p.textContent="")};window.stopStreaming=function(){t&&(t.stopStream(),E.disabled=!1,I.disabled=!0)};let c=0;i.addEventListener("input",()=>{if(!t||!t.isActive())return;const e=i.value;if(e.length>c){const a=e.slice(c);t.onToken(a),document.getElementById("token-count").textContent=t.getTokenCount()}c=e.length});window.simulateLLM=async function(){if(!t){alert("Please create a session first!");return}startStreaming();const a=`Hello! I'm an AI assistant demonstrating real-time P2P text streaming. 

This text is being sent through WebRTC directly to connected peers, with no central server involved. Each token is synchronized using CRDT-style conflict-free replication.

Key features:
• Serverless P2P connection via Trystero
• Real-time text synchronization
• QR code session sharing
• Browser-based storage

The connection uses Nostr relays for signaling, but all data transfer happens directly peer-to-peer after the initial handshake.`.split(new RegExp("(?<=[ \\n])"));for(const u of a){if(!t.isActive())break;t.onToken(u),document.getElementById("token-count").textContent=t.getTokenCount(),i.value+=u,c=i.value.length,await new Promise(x=>setTimeout(x,30+Math.random()*50))}stopStreaming()};
