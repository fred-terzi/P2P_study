import{c as x,a as k,v as A,h as H,C as E,e as M,d as N,f as O}from"./storage-D35zsQYn.js";import{joinRoom as U}from"https://esm.sh/trystero/mqtt";const q="modulepreload",F=function(t){return"/"+t},w={},W=function(e,o,n){let i=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),s=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=Promise.allSettled(o.map(r=>{if(r=F(r),r in w)return;w[r]=!0;const y=r.endsWith(".css"),L=y?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${L}`))return;const c=document.createElement("link");if(c.rel=y?"stylesheet":q,y||(c.as="script"),c.crossOrigin="",c.href=r,s&&c.setAttribute("nonce",s),document.head.appendChild(c),y)return new Promise((P,T)=>{c.addEventListener("load",P),c.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${r}`)))})}))}function d(a){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=a,window.dispatchEvent(s),!s.defaultPrevented)throw a}return i.then(a=>{for(const s of a||[])s.status==="rejected"&&d(s.reason);return e().catch(d)})},$=O(localStorage),Q=M($),V=N();let v,I,B=null,g=0,l=null;const p=document.getElementById("status-dot"),h=document.getElementById("status-text"),m=document.getElementById("room-input"),D=document.getElementById("join-btn"),R=document.getElementById("leave-btn"),_=document.getElementById("scan-btn"),S=document.getElementById("room-id"),f=document.getElementById("output"),C=document.getElementById("scanner-container"),u=document.getElementById("scanner-video");function j(t){switch(p.className="status-dot",t){case E.CONNECTED:p.classList.add("connected"),h.textContent="Connected";break;case E.CONNECTING:p.classList.add("connecting"),h.textContent="Connecting...";break;case E.ERROR:h.textContent="Error";break;default:h.textContent="Disconnected"}}function G(t){if(t=t.trim(),A(t))return t;try{const e=H(t);if(e&&e.roomId)return e.roomId}catch{}try{const e=V.parseFromUrl(t);if(e&&e.roomId)return e.roomId}catch{}return null}window.joinSession=async function(){const t=m.value,e=G(t);if(!e){alert("Invalid Room ID or QR data. Please enter a valid Room ID.");return}try{I=x({onTextChange:n=>{f.innerHTML=n?`${n}<span class="cursor"></span>`:'<span style="color: #888;">Waiting for stream...</span>',document.getElementById("char-count").textContent=n.length,n&&f.classList.add("streaming")},onSync:()=>{g++,document.getElementById("update-count").textContent=g}}),v=k({onPeerJoin:n=>{console.log("Host connected:",n)},onPeerLeave:n=>{console.log("Host disconnected:",n)},onStateChange:j,onData:(n,i)=>{console.log("Received data:",n),g++,document.getElementById("update-count").textContent=g,n&&typeof n=="object"&&I.merge(n)}}),B=e,await v.join(e,U),S.style.display="block",S.textContent=`Connected to: ${e}`,D.disabled=!0,_.disabled=!0,R.disabled=!1,m.disabled=!0,f.innerHTML='<span style="color: #888;">Connected! Waiting for stream...</span>';const o=Q.loadDocument(e);o&&I.merge(o)}catch(o){console.error("Failed to join session:",o),alert("Failed to join session: "+o.message)}};window.leaveSession=function(){v&&v.leave(),B=null,g=0,S.style.display="none",D.disabled=!1,_.disabled=!1,R.disabled=!0,m.disabled=!1,m.value="",f.innerHTML='<span style="color: #888;">Waiting to connect to a session...</span>',f.classList.remove("streaming"),document.getElementById("char-count").textContent="0",document.getElementById("update-count").textContent="0",j(E.DISCONNECTED)};window.toggleScanner=async function(){if(l){l.getTracks().forEach(t=>t.stop()),l=null,C.style.display="none";return}try{C.style.display="block",l=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),u.srcObject=l;const t=(await W(async()=>{const{default:i}=await import("https://esm.sh/jsqr@1.4.0");return{default:i}},[])).default,e=document.createElement("canvas"),o=e.getContext("2d"),n=()=>{if(l){if(u.readyState===u.HAVE_ENOUGH_DATA){e.width=u.videoWidth,e.height=u.videoHeight,o.drawImage(u,0,0,e.width,e.height);const i=o.getImageData(0,0,e.width,e.height),d=t(i.data,e.width,e.height);if(d){console.log("Scanned:",d.data),m.value=d.data,toggleScanner(),joinSession();return}}requestAnimationFrame(n)}};requestAnimationFrame(n)}catch(t){console.error("Camera error:",t),alert("Could not access camera: "+t.message),C.style.display="none"}};const J=new URLSearchParams(window.location.search),b=J.get("session");b&&(m.value=b,setTimeout(joinSession,500));
