(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))f(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&f(u)}).observe(document,{childList:!0,subtree:!0});function s(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function f(a){if(a.ep)return;a.ep=!0;const i=s(a);fetch(a.href,i)}})();const D={appId:"p2p-llm-stream",relayUrls:["wss://relay.nostr.band","wss://nostr.mutinywallet.com","wss://relay.primal.net","wss://purplepag.es"],relayRedundancy:2},m={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected",ERROR:"error"};function A(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}function I(t){return typeof t!="string"?!1:/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function H(t={}){const e={...D,...t};let s=m.DISCONNECTED,f=null,a=new Set,i={};const u={onPeerJoin:t.onPeerJoin||(()=>{}),onPeerLeave:t.onPeerLeave||(()=>{}),onStateChange:t.onStateChange||(()=>{}),onData:t.onData||(()=>{})};function c(y){s!==y&&(s=y,u.onStateChange(y))}async function l(y,S){if(!I(y))throw c(m.ERROR),new Error("Invalid room ID format");c(m.CONNECTING);try{f=S({appId:e.appId,relayUrls:e.relayUrls,relayRedundancy:e.relayRedundancy},y),f.onPeerJoin(g=>{a.add(g),u.onPeerJoin(g),s!==m.CONNECTED&&c(m.CONNECTED)}),f.onPeerLeave(g=>{a.delete(g),u.onPeerLeave(g),a.size===0&&c(m.CONNECTING)});const[v,o]=f.makeAction("sync");return i.sendData=v,o((g,T)=>u.onData(g,T)),f}catch(v){throw c(m.ERROR),v}}function r(){f&&(f.leave(),f=null,a.clear(),i={},c(m.DISCONNECTED))}function n(y){i.sendData&&i.sendData(y)}function d(){return s}function p(){return Array.from(a)}function h(){return a.size}return{join:l,leave:r,broadcast:n,getState:d,getPeers:p,getPeerCount:h,config:e}}const x={SNAPSHOT:"snapshot",TEXT_CHANGE:"text-change"};function R(t){const e=JSON.stringify(t);return new TextEncoder().encode(e)}function U(t){const s=new TextDecoder().decode(t);return JSON.parse(s)}function _(t={}){let e={text:"",chunks:[],version:0,lastUpdated:null};const s={onTextChange:t.onTextChange||(()=>{}),onSync:t.onSync||(()=>{})},f=new Set;function a(o){return f.add(o),()=>f.delete(o)}function i(o,g){f.forEach(T=>T(o,g))}function u(o){if(typeof o!="string")throw new TypeError("Text must be a string");return e.text+=o,e.chunks.push({content:o,timestamp:Date.now(),index:e.chunks.length}),e.version++,e.lastUpdated=Date.now(),s.onTextChange(e.text),i(x.TEXT_CHANGE,{text:o,fullText:e.text}),{...e}}function c(o){if(typeof o!="string")throw new TypeError("Text must be a string");return e.text=o,e.chunks=[{content:o,timestamp:Date.now(),index:0}],e.version++,e.lastUpdated=Date.now(),s.onTextChange(e.text),i(x.TEXT_CHANGE,{text:o,fullText:o}),{...e}}function l(){return e.text}function r(){return{...e}}function n(){return e.version}function d(){return R(e)}function p(o){const g=U(o);return g.version>e.version&&(e={...g},s.onTextChange(e.text),s.onSync(e),i(x.SNAPSHOT,e)),{...e}}function h(o){return o.type==="append"&&o.text?u(o.text):o.type==="set"&&o.text!==void 0?c(o.text):{...e}}function y(o){return!o||typeof o!="object"?{...e}:(o.version>e.version?(e={...o},s.onTextChange(e.text),s.onSync(e),i(x.SNAPSHOT,e)):o.version===e.version&&o.lastUpdated>e.lastUpdated&&(e={...o},s.onTextChange(e.text),s.onSync(e),i(x.SNAPSHOT,e)),{...e})}function S(){e={text:"",chunks:[],version:0,lastUpdated:null},i(x.TEXT_CHANGE,{text:"",fullText:""})}function v(){return e.chunks.length}return{appendText:u,setText:c,getText:l,getState:r,getVersion:n,createSnapshot:d,applySnapshot:p,applyUpdate:h,merge:y,reset:S,observe:a,getChunkCount:v}}function G(t,e){let s=!1,f=0;function a(r){s&&(f++,t.appendText(r),e&&e.broadcast&&e.broadcast({type:"append",text:r,tokenIndex:f}))}function i(){s=!0,f=0,t.reset()}function u(){s=!1}function c(){return s}function l(){return f}return{onToken:a,startStream:i,stopStream:u,isActive:c,getTokenCount:l}}const N={errorCorrectionLevel:"M",width:256,margin:2,color:{dark:"#000000",light:"#ffffff"}},w="1.0";function C(t,e={}){if(!t||typeof t!="string")throw new Error("Room ID is required and must be a string");return{roomId:t,encryptionKey:e.encryptionKey||null,timestamp:Date.now(),version:w}}function E(t){if(!t||!t.roomId)throw new Error("Invalid session data");const e=JSON.stringify(t);return typeof btoa=="function"?btoa(e):Buffer.from(e).toString("base64")}function P(t){if(!t||typeof t!="string")throw new Error("Invalid encoded data");try{let e;typeof atob=="function"?e=atob(t):e=Buffer.from(t,"base64").toString("utf-8");const s=JSON.parse(e);if(!s.roomId)throw new Error("Missing roomId in session data");return s}catch(e){throw e.message.includes("roomId")?e:new Error("Failed to decode session data: "+e.message)}}function b(t){const e=[];return t?((!t.roomId||typeof t.roomId!="string")&&e.push("roomId is required and must be a string"),t.version?t.version!==w&&e.push(`Incompatible protocol version: ${t.version}, expected ${w}`):e.push("version is required"),(!t.timestamp||typeof t.timestamp!="number")&&e.push("timestamp is required and must be a number"),{valid:e.length===0,errors:e}):{valid:!1,errors:["Session data is required"]}}function L(t=null){let e=null;async function s(l,r={}){const n=C(l,r),d=E(n);return e=n,t&&t.toDataURL?await t.toDataURL(d,{...N,...r.qrOptions}):`data:image/png;base64,mock_qr_${d}`}async function f(l,r,n={}){const d=C(r,n),p=E(d);return e=d,t&&t.toCanvas&&await t.toCanvas(l,p,{...N,...n.qrOptions}),d}function a(l){const r=P(l),n=b(r);if(!n.valid)throw new Error("Invalid QR code: "+n.errors.join(", "));return r}function i(){return e}function u(l,r,n={}){const d=C(r,n),p=E(d),h=new URL(l);return h.searchParams.set("session",p),h.toString()}function c(l){try{const n=new URL(l).searchParams.get("session");return n?a(n):null}catch{return null}}return{generate:s,generateToCanvas:f,parse:a,getLastGenerated:i,createShareUrl:u,parseFromUrl:c}}const O={DOCUMENT:"p2p_document",HISTORY:"p2p_history"};function J(t){if(!t){const u=new Map;t={getItem:c=>u.get(c)||null,setItem:(c,l)=>u.set(c,l),removeItem:c=>u.delete(c),clear:()=>u.clear(),keys:()=>Array.from(u.keys())}}function e(u){try{const c=t.getItem(u);return c===null?null:JSON.parse(c)}catch{return null}}function s(u,c){try{return t.setItem(u,JSON.stringify(c)),!0}catch(l){return console.error("Storage set error:",l),!1}}function f(u){try{return t.removeItem(u),!0}catch{return!1}}function a(){try{return t.clear(),!0}catch{return!1}}function i(u){return t.getItem(u)!==null}return{get:e,set:s,remove:f,clear:a,has:i}}function j(t){const e=O.DOCUMENT+"_";function s(r,n){if(!r||typeof r!="string")throw new Error("Document ID is required");const d={id:r,state:n,savedAt:Date.now(),version:n.version||0};return u(r,n),t.set(e+r,d)}function f(r){if(!r)return null;const n=t.get(e+r);return n?n.state:null}function a(r){return r?t.remove(e+r):!1}function i(r){const n=t.get(e+r);return n?{id:n.id,savedAt:n.savedAt,version:n.version}:null}function u(r,n){const d=O.HISTORY+"_"+r;let p=t.get(d)||[];p.push({state:n,timestamp:Date.now(),version:n.version||0}),p.length>10&&(p=p.slice(-10)),t.set(d,p)}function c(r){const n=O.HISTORY+"_"+r;return t.get(n)||[]}function l(r,n){const d=c(r);return n<0||n>=d.length?null:d[n].state}return{saveDocument:s,loadDocument:f,deleteDocument:a,getDocumentMeta:i,getHistory:c,restoreFromHistory:l}}export{m as C,H as a,G as b,_ as c,L as d,j as e,J as f,A as g,P as h,I as v};
