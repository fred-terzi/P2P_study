<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Stream - Host (Direct WebRTC)</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { text-align: center; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #888; margin-bottom: 20px; }
    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
    }
    .status-dot.connected { background: #0f0; }
    .status-dot.connecting { background: #ff0; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .steps {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .step {
      flex: 1;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .step.active { background: rgba(76, 175, 80, 0.3); border: 2px solid #4CAF50; }
    .step.done { background: rgba(76, 175, 80, 0.2); opacity: 0.7; }
    .step-number {
      width: 30px;
      height: 30px;
      background: #4CAF50;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    #qr-container {
      text-align: center;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      display: inline-block;
      margin: 10px auto;
    }
    #qr-code { width: 250px; height: 250px; }
    
    .scanner-container {
      display: none;
      text-align: center;
    }
    .scanner-container.active { display: block; }
    #scanner-video {
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      background: #000;
    }
    
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #666; cursor: not-allowed; }
    button.secondary { background: #2196F3; }
    button.danger { background: #f44336; }
    
    textarea {
      width: 100%;
      height: 150px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      color: #fff;
      font-size: 14px;
      resize: vertical;
    }
    textarea:focus { outline: none; border-color: #4CAF50; }
    
    .output {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    
    .manual-entry {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    .manual-entry input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñ•Ô∏è P2P Stream - Host</h1>
    <p class="subtitle">Direct WebRTC Connection (No Relay Servers)</p>

    <div class="card">
      <div class="status">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Not Started</span>
      </div>
      
      <div class="steps">
        <div class="step" id="step1">
          <div class="step-number">1</div>
          <div>Create Session</div>
        </div>
        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div>Client Scans Your QR</div>
        </div>
        <div class="step" id="step3">
          <div class="step-number">3</div>
          <div>Scan Client's QR</div>
        </div>
        <div class="step" id="step4">
          <div class="step-number">4</div>
          <div>Connected!</div>
        </div>
      </div>
    </div>

    <!-- Step 1: Create Session -->
    <div class="card" id="create-section">
      <h3>Step 1: Create Session</h3>
      <p>Click to generate your connection QR code.</p>
      <button onclick="createSession()" id="create-btn">üì° Create Session</button>
    </div>

    <!-- Step 2: Show QR for client to scan -->
    <div class="card" id="offer-section" style="display: none;">
      <h3>Step 2: Show This QR to Client</h3>
      <p>Have the client scan this QR code with their device.</p>
      <div style="text-align: center;">
        <div id="qr-container">
          <canvas id="qr-code"></canvas>
        </div>
      </div>
      <div class="manual-entry">
        <p style="color: #888; font-size: 12px;">Or copy this code manually:</p>
        <input type="text" id="offer-text" readonly onclick="this.select()">
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="proceedToScan()" class="secondary">Client Has Scanned ‚Üí Next Step</button>
      </div>
    </div>

    <!-- Step 3: Scan client's answer QR -->
    <div class="card" id="scan-section" style="display: none;">
      <h3>Step 3: Scan Client's QR Code</h3>
      <p>Now scan the QR code displayed on the client's device.</p>
      
      <div class="scanner-container active" id="scanner-container">
        <video id="scanner-video" autoplay playsinline></video>
        <p style="color: #888;">Point camera at client's QR code</p>
      </div>
      
      <div class="manual-entry">
        <p style="color: #888; font-size: 12px;">Or paste the client's code manually:</p>
        <input type="text" id="answer-input" placeholder="Paste client's answer code here...">
        <button onclick="submitAnswer()" style="margin-top: 10px;">Submit Answer</button>
      </div>
    </div>

    <!-- Step 4: Connected - Stream -->
    <div class="card" id="stream-section" style="display: none;">
      <h3>üéâ Connected! Start Streaming</h3>
      
      <div style="margin-bottom: 15px;">
        <h4>Type or paste text to stream:</h4>
        <textarea id="llm-input" placeholder="Enter text here..."></textarea>
      </div>
      
      <div>
        <button onclick="startStreaming()" id="start-btn">‚ñ∂Ô∏è Start Streaming</button>
        <button onclick="stopStreaming()" id="stop-btn" class="danger" disabled>‚èπÔ∏è Stop</button>
        <button onclick="sendAll()" class="secondary">üì§ Send All at Once</button>
      </div>
      
      <h4>Sent Output:</h4>
      <div class="output" id="output"></div>
    </div>

    <!-- Disconnect -->
    <div class="card" id="disconnect-section" style="display: none;">
      <button onclick="disconnect()" class="danger">üîå Disconnect</button>
    </div>
  </div>

  <script type="module">
    import QRCode from 'https://esm.sh/qrcode@1.5.3';
    import { createDirectConnection, DirectConnectionState } from './src/modules/webrtc-direct.js';

    let connection = null;
    let scannerStream = null;
    let isStreaming = false;
    let streamIndex = 0;

    // UI Elements
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const qrCanvas = document.getElementById('qr-code');
    const offerText = document.getElementById('offer-text');
    const answerInput = document.getElementById('answer-input');
    const output = document.getElementById('output');
    const llmInput = document.getElementById('llm-input');

    function updateStatus(state) {
      statusDot.className = 'status-dot';
      
      switch (state) {
        case DirectConnectionState.CONNECTED:
          statusDot.classList.add('connected');
          statusText.textContent = 'Connected';
          break;
        case DirectConnectionState.CONNECTING:
        case DirectConnectionState.OFFERING:
        case DirectConnectionState.ANSWERING:
          statusDot.classList.add('connecting');
          statusText.textContent = 'Connecting...';
          break;
        case DirectConnectionState.FAILED:
          statusText.textContent = 'Failed';
          break;
        default:
          statusText.textContent = 'Disconnected';
      }
    }

    function setActiveStep(step) {
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById(`step${i}`);
        el.classList.remove('active', 'done');
        if (i < step) el.classList.add('done');
        if (i === step) el.classList.add('active');
      }
    }

    window.createSession = async function() {
      try {
        connection = createDirectConnection({
          onStateChange: (state) => {
            updateStatus(state);
            if (state === DirectConnectionState.CONNECTED) {
              showConnected();
            }
          },
          onMessage: (msg) => {
            console.log('Received:', msg);
          },
          onError: (err) => {
            console.error('Connection error:', err);
            alert('Connection error: ' + err.message);
          }
        });

        document.getElementById('create-btn').disabled = true;
        document.getElementById('create-btn').textContent = 'Generating...';

        const offer = await connection.createOffer();
        
        // Generate QR code
        await QRCode.toCanvas(qrCanvas, offer, {
          width: 250,
          margin: 2,
          errorCorrectionLevel: 'L' // Lower error correction = more data capacity
        });
        
        offerText.value = offer;
        
        // Show offer section
        document.getElementById('create-section').style.display = 'none';
        document.getElementById('offer-section').style.display = 'block';
        setActiveStep(2);
        
      } catch (error) {
        console.error('Failed to create session:', error);
        alert('Failed to create session: ' + error.message);
        document.getElementById('create-btn').disabled = false;
        document.getElementById('create-btn').textContent = 'üì° Create Session';
      }
    };

    window.proceedToScan = async function() {
      document.getElementById('offer-section').style.display = 'none';
      document.getElementById('scan-section').style.display = 'block';
      setActiveStep(3);
      
      // Start camera for scanning
      try {
        const jsQR = (await import('https://esm.sh/jsqr@1.4.0')).default;
        
        scannerStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        
        const video = document.getElementById('scanner-video');
        video.srcObject = scannerStream;
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const scan = () => {
          if (!scannerStream) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);
            
            if (code) {
              console.log('Scanned answer:', code.data);
              answerInput.value = code.data;
              submitAnswer();
              return;
            }
          }
          requestAnimationFrame(scan);
        };
        
        requestAnimationFrame(scan);
        
      } catch (error) {
        console.error('Camera error:', error);
        // Continue without camera - user can paste manually
      }
    };

    window.submitAnswer = async function() {
      const answer = answerInput.value.trim();
      if (!answer) {
        alert('Please scan or paste the client\'s answer code');
        return;
      }
      
      try {
        // Stop scanner
        if (scannerStream) {
          scannerStream.getTracks().forEach(t => t.stop());
          scannerStream = null;
        }
        
        await connection.acceptAnswer(answer);
        
        // Wait a moment for connection to establish
        setTimeout(() => {
          if (connection.isConnected()) {
            showConnected();
          }
        }, 1000);
        
      } catch (error) {
        console.error('Failed to accept answer:', error);
        alert('Failed to accept answer: ' + error.message);
      }
    };

    function showConnected() {
      document.getElementById('scan-section').style.display = 'none';
      document.getElementById('stream-section').style.display = 'block';
      document.getElementById('disconnect-section').style.display = 'block';
      setActiveStep(4);
    }

    window.startStreaming = function() {
      const text = llmInput.value;
      if (!text) {
        alert('Enter some text to stream');
        return;
      }
      
      isStreaming = true;
      streamIndex = 0;
      document.getElementById('start-btn').disabled = true;
      document.getElementById('stop-btn').disabled = false;
      output.textContent = '';
      
      streamNextChar();
    };

    function streamNextChar() {
      if (!isStreaming) return;
      
      const text = llmInput.value;
      if (streamIndex < text.length) {
        const char = text[streamIndex];
        output.textContent += char;
        
        try {
          connection.send({ type: 'token', data: char });
        } catch (e) {
          console.error('Send error:', e);
        }
        
        streamIndex++;
        setTimeout(streamNextChar, 50); // Simulate typing speed
      } else {
        stopStreaming();
      }
    }

    window.stopStreaming = function() {
      isStreaming = false;
      document.getElementById('start-btn').disabled = false;
      document.getElementById('stop-btn').disabled = true;
    };

    window.sendAll = function() {
      const text = llmInput.value;
      if (!text) return;
      
      try {
        connection.send({ type: 'full', data: text });
        output.textContent = text;
      } catch (e) {
        console.error('Send error:', e);
        alert('Send error: ' + e.message);
      }
    };

    window.disconnect = function() {
      if (scannerStream) {
        scannerStream.getTracks().forEach(t => t.stop());
        scannerStream = null;
      }
      
      if (connection) {
        connection.close();
        connection = null;
      }
      
      location.reload();
    };
  </script>
</body>
</html>
